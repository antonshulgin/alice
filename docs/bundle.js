(t=>{"use strict";function e(t=0){return t>1e3?`${(t/1e3).toFixed(1)}k`:t}window.addEventListener("DOMContentLoaded",(function(){const e={controls:document.getElementById("Controls"),overview:document.getElementById("Overview")},n={lookup:t.Lookup({onResolved:function(n=[]){r(),Promise.any(n.map((n=>function(n){const s=t.Pilot(n);function r(){setTimeout(s.fetchDetails,o()),setTimeout(s.fetchCombatStats,o()),setTimeout(s.fetchShipStats,o())}e.overview.appendChild(s.render()),t.libCache.getItem(`pilotIds/${n}`).then((()=>{r()})).catch((()=>{t.libCache.saveItem(`pilotIds/${n}`,n),r()}))}(n)))).then(s).catch(console.error)}})};function o(){return Math.round(7*Math.random())}function s(n){e.overview.classList.toggle("hidden",n?.length<=0),t.libCache.clearExpired()}function r(){t.libNet.resetTimedQueryCount(),e.overview.classList.toggle("hidden",!0),e.overview.replaceChildren()}r(),e.controls.appendChild(n.lookup.render()),n.lookup.setFocus()}),{once:!0,passive:!0}),t.ESI_VERSION="latest",t.ENDPOINT_ESI=`https://esi.evetech.net/${t.ESI_VERSION}`,t.ENDPOINT_ZKB="https://zkillboard.com/api",t.TYPE_IDS_IGNORED=[33328,33474,33475,57319,670,NaN,null,void 0],t.humanisePlural=function(t,n,o){return 1===t?`${e(t)} ${n}`:`${e(t)} ${o||n}`},t.humaniseCount=e,t.humaniseDate=function(t=new Date){return t?.toLocaleDateString()||"???"},t.jsonDecode=function(t=""){return new Promise(((e,n)=>{let o;try{o=JSON.parse(t)}catch(e){return console.warn("Failed to decode JSON",{jsonString:t}),n(t)}return e(o)}))},t.jsonDecodeSync=function(t=""){let e;try{e=JSON.parse(t)}catch(e){return console.warn("Failed to decode JSON",{jsonString:t}),{}}return e},t.jsonEncode=function(t={}){return new Promise(((e,n)=>{let o;try{o=JSON.stringify(t)}catch(e){return console.warn("Failed to encode JSON",{json:t}),n(t)}return e(o)}))},t.jsonEncodeSync=function(t={}){let e;try{e=JSON.stringify(t)}catch(e){return console.warn("Failed to encode JSON",{json:t}),""}return e},t.clearState=function(){localStorage.clear(),location.reload()}})(window.A={}),(t=>{"use strict";window.addEventListener("DOMContentLoaded",r,{once:!0,passive:!0});const e="https://login.eveonline.com/v2/oauth",n="https://login.eveonline.com/.well-known/oauth-authorization-server",o="7eae96ab6dc3483b850bfec0fa3673f4",s=["esi-search.search_structures.v1"].join(" ");function r(){const s=f(),r=new URL(location).searchParams.get("state");return i()||s||r?s&&r?r===c()?function(s){const r=new FormData,a=localStorage.getItem("codeVerifier");r.set("client_id",`${o}`),r.set("grant_type","authorization_code"),r.set("code",`${s}`),r.set("code_verifier",`${a}`);const i=new URLSearchParams(r).toString(),c=new Headers;c.set("Content-Type","application/x-www-form-urlencoded"),c.set("Host","login.eveonline.com");const l=new URL(`${e}/token`);fetch(l,{method:"POST",body:i,headers:c}).then((t=>t.json())).then((e=>function(e){const o=e.access_token,s=function(e){console.log("parseJwt",{jwt:e});const[n,o,s]=e.split(".");return{header:t.jsonDecodeSync(h(n)),payload:t.jsonDecodeSync(h(o)),signature:s}}(o);function r(t){var e;console.log("validateAccessToken doValidate",{metadata:t,accessTokenParsed:s}),e=function(t){const e=t?.payload?.sub?.split(":").pop();return e}(s),localStorage.setItem("pilotId",e),function(t){localStorage.setItem("accessToken",t)}(o),location.assign(`${location.origin}${location.pathname}`)}console.log("validateAccessToken doValidate",{response:e,accessToken:o,accessTokenParsed:s}),fetch(n).then((t=>t.json())).then((t=>r(t))).catch((t=>console.error("validateAccessToken reject",{response:t})))}(e))).catch((t=>console.error("fetchAccessToken reject",{response:t})))}(s):a():void 0:a()}function a(){const t=new URL(`${e}/authorize`);l().then((function(e){t.searchParams.set("response_type","code"),t.searchParams.set("redirect_uri",`${location.origin}${location.pathname}`),t.searchParams.set("client_id",`${o}`),t.searchParams.set("scope",`${s}`),t.searchParams.set("state",`${function(){const t=function(t=[]){return[...t].map((t=>t.toString(16).padStart(2,0))).join("")}(m(4));return localStorage.setItem("oauthState",t),c()}()}`),t.searchParams.set("code_challenge_method","S256"),t.searchParams.set("code_challenge",`${e}`),location.assign(t)})).catch(console.error)}function i(){return localStorage.getItem("accessToken")}function c(){return localStorage.getItem("oauthState")}function l(){return new Promise(((t,e)=>{const n=d(m(32));localStorage.setItem("codeVerifier",n),u(n).then((e=>t(d(e)))).catch(e)}))}function u(t=""){return new Promise(((e,n)=>{const o=(new TextEncoder).encode(t);crypto.subtle.digest("SHA-256",o).then((t=>e([...new Uint8Array(t)]))).catch(n)}))}function d(t=new Uint8Array){const e=[...t].map((t=>String.fromCharCode(t))).join("");return btoa(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function h(t){const e=t.replace(/-/g,"+").replace(/_/g,"/");return atob(e)}function m(t=8){return new Uint8Array(t).fill().map((()=>Math.round(255*Math.random())))}function f(){return new URL(location).searchParams.get("code")}t.libAuth={authorize:a,base64UrlDecode:h,base64UrlEncode:d,dispatchAuthState:r,getAccessToken:i,getOauthState:c,getParamAuthCode:f,getPilotId:function(){return localStorage.getItem("pilotId")},prepareCodeChallenge:l,toSha256:u}})(window.A),(t=>{"use strict";const e={};function n(t={}){if(!t?.lastCached)return!0;return Math.abs(Date.now()-t.lastCached)>=18e5}t.libCache={clearExpired:function(){return new Promise(((o,s)=>(Object.values(e).forEach((o=>{t.jsonDecode(o).then((t=>{var o;n(t)&&(o=t.key,new Promise((t=>(delete e[o],t()))))})).catch(s)})),o())))},getItem:function(o){return new Promise(((s,r)=>{t.jsonDecode(e[o]).then((function(t={}){return n(t)?r():s(t.value)})).catch(r)}))},saveItem:function(n,o={}){return new Promise(((s,r)=>{const a={key:n,value:o,lastCached:Date.now()};t.jsonEncode(a).then((function(t){return e[n]=t,s(a.value)})).catch(r)}))}}})(window.A),(t=>{"use strict";const e={timedQueryCount:0},n=new RegExp(t.ENDPOINT_ESI);t.libNet={resetTimedQueryCount:function(){e.timedQueryCount=0},load:function(o="",s=!1){return new Promise(((r,a)=>{if(!o)return console.error("No URL given"),a();function i(){const e=function(e){const o=new Headers;(function(t){return n.test(t)})(e)&&o.set("Authorization",`Bearer ${t.libAuth.getAccessToken()}`);return o}(o);fetch(o,{headers:e}).then((t=>t.json())).then((e=>t.libCache.saveItem(o,e))).then((t=>r(t))).catch(c)}function c(t){return console.warn("libNet load reject",{response:t}),a(t)}t.libCache.getItem(o).then((t=>r(t))).catch((()=>setTimeout(i,s?1e3*(e.timedQueryCount+=1,e.timedQueryCount||0):0)))}))}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateLookup");t.Lookup=(n={})=>{const o=document.importNode(e.content,!0).firstChild;return o.addEventListener("submit",(function(t){t.preventDefault(),o.doLookup.textContent="Working",o.doLookup.classList.toggle("busy",!0),Promise.resolve(o.names.value).then((t=>r(t))).then((t=>function(t=[]){return new Promise(((e,n)=>{Promise.all(t.map(a)).then((t=>e(t.flat(1)))).catch(n)}))}(t))).then((t=>function(t){return function(){o.doLookup.textContent="Ready",o.doLookup.classList.toggle("busy",!0),setTimeout(c,1e3)}(),n?.onResolved(t)}(t))).catch(i)})),o.names.addEventListener("focus",s),o.doReset.addEventListener("click",t.clearState),{setFocus:s,render:function(){return o},parseNames:r};function s(){o.names.select()}function r(t=""){return new Promise((e=>e([...new Set(t.split(/\n+/).map((t=>t.trim().toLowerCase())).filter((t=>t.length>0)))])))}function a(e=""){return new Promise(((n,o)=>{t.libNet.load(`${t.ENDPOINT_ESI}/characters/${t.libAuth.getPilotId()}/search/?search=${encodeURIComponent(e)}&categories=character&strict=true`).then((function(t){return n(t?.character||[])})).catch(o)}))}function i(t){console.error(t),o.doLookup.textContent="Could not",o.doLookup.classList.toggle("busy",!0),setTimeout(c,1e3)}function c(){o.doLookup.textContent="Look up",o.doLookup.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateShipStats");t.ShipStats=n=>{const o=document.importNode(e.content,!0).firstChild,s={doFetch:o.querySelector(".ShipStats-fetch-stats"),ships:o.querySelector(".ShipStats-ships")};return s.doFetch.addEventListener("click",(()=>r(!1)),{passive:!0}),{render:function(){return o},fetchShipStats:r};function r(e=!0){return new Promise(((n,r)=>{if(!i())return n(void 0);s.doFetch.textContent="Getting ship stats",s.doFetch.classList.toggle("busy",!0),Promise.resolve().then((()=>function(e=!0){return t.libNet.load(`${t.ENDPOINT_ZKB}/characterID/${i()}/`,!!e)}(e))).then((t=>function(t=[]){return Promise.all(t.slice(0,7).map(c))}(t))).then((e=>function(e=[]){return new Promise((n=>{const o=e.reduce(((e,n)=>e.concat(function(e,n){return[].concat(function(e,n){const o=parseInt(e.victim.character_id),s=parseInt(e.victim.ship_type_id);if(isNaN(o)||isNaN(s))return;if(t.TYPE_IDS_IGNORED.includes(s))return;if(o!==n)return;return{characterId:o,date:new Date(e.killmail_time),id:s,info:{},isKill:!1}}(e,n),function(e,n){const o=e.attackers.reduce(((o,s)=>{const r=parseInt(s.character_id),a=parseInt(s.ship_type_id);return isNaN(r)||isNaN(a)||t.TYPE_IDS_IGNORED.includes(a)||r!==n?o:o.concat({characterId:r,date:new Date(e.killmail_time),id:a,info:{},isKill:!0})}),[]);return o}(e,n)).flat(1).filter((t=>!!t))}(n,i()))),[]).sort(((t,e)=>e.date-t.date));return n(function(t=[]){const e=t.reduce(((t,e)=>{var n,o;return t[e.id]||(t[e.id]={id:e.id,fights:[],losses:0,kills:0,total:0,dates:[]}),t[e.id]=(n=e,(o=t[e.id]).total+=1,o.losses+=n.isKill?0:1,o.kills+=n.isKill?1:0,o.fights.push(n),o.dates.push(n.date),o.dates.sort(((t,e)=>e-t)),o),t}),{});Object.values(e).forEach((t=>{t.dateLastSeen=t.dates.sort(((t,e)=>e-t))[0]}));return Object.values(e).sort(((t,e)=>e.dateLastSeen-t.dateLastSeen)).slice(0,3)}(o))}))}(e))).then((t=>function(t=[]){return new Promise(((e,n)=>{function o(t){return e(t)}Promise.all(t.map(a)).then(o).catch(n)}))}(t))).then((t=>function(t=[]){return new Promise((e=>{const n=t.reduce(((t,e)=>e.total>t?e.total:t),0);return t.forEach((t=>{t.ratio=t.total/(n||1)})),e(t)}))}(t))).then((e=>function(e){return function(e=[]){const n=e.map(t.ShipStatsTile);s.ships.replaceChildren(...n.map((t=>t.render()))),o.classList.toggle("ready",!0),l()}(e),n(e)}(e))).catch((function(t){return s.doFetch.textContent="Could not",setTimeout(l,1e3),r(t)}))}))}function a(e={}){return new Promise(((n,o)=>{t.libNet.load(`${t.ENDPOINT_ESI}/universe/types/${e.id}`).then((function(t){return e.info=t,n(e)})).catch(o)}))}function i(){return n}function c(e={}){return t.libNet.load(`${t.ENDPOINT_ESI}/killmails/${e.killmail_id}/${e.zkb.hash}`)}function l(){s.doFetch.textContent="Get ship stats",s.doFetch.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templatePilot"),n={CALDARI:500001,MINMATAR:500002,AMARR:500003,GALLENTE:500004},o={[n.CALDARI]:"caldari",[n.MINMATAR]:"minmatar",[n.AMARR]:"amarr",[n.GALLENTE]:"gallente"};t.Pilot=s=>{const r=document.importNode(e.content,!0).firstChild,a={portrait:r.querySelector(".Pilot-portrait"),summary:r.querySelector(".Pilot-summary"),status:r.querySelector(".Pilot-status"),name:r.querySelector(".Pilot-name"),affiliation:r.querySelector(".Pilot-affiliation"),alliance:r.querySelector(".Pilot-alliance"),corp:r.querySelector(".Pilot-corp"),militia:r.querySelector(".Pilot-militia"),combatStats:r.querySelector(".Pilot-combat-stats"),shipStats:r.querySelector(".Pilot-ship-stats")},i={combatStats:t.CombatStats(c()),shipStats:t.ShipStats(c())};return a.combatStats.replaceChildren(i.combatStats.render()),a.shipStats.replaceChildren(i.shipStats.render()),{MILITIA_ID:n,MILITIA_LABEL:o,render:function(){return r},fetchDetails:function(){Promise.all([new Promise(((e,n)=>{[a.portrait,a.status,a.name,a.alliance,a.corp,a.militia].forEach((t=>t.classList.toggle("busy",!0))),t.libNet.load(`${t.ENDPOINT_ESI}/characters/${c()}`).then((function(t){return function(t){a.summary.href=`https://zkillboard.com/character/${c()}`,a.name.textContent=t,a.name.classList.toggle("busy",!1)}(t.name),function(t=0){a.status.dataset.status=Math.round(t)||0,a.status.classList.toggle("busy",!1)}(t.security_status),e(t)})).catch((function(t){return a.portrait.classList.toggle("busy",!1),n(t)}))})),new Promise(((e,n)=>{a.portrait.classList.toggle("busy",!0),t.libNet.load(`${t.ENDPOINT_ESI}/characters/${c()}/portrait`).then((function(t){return function(t={}){a.portrait.src=t.px64x64||"",a.portrait.classList.toggle("busy",!1)}(t),e(t)})).catch((function(t){return a.portrait.classList.toggle("busy",!1),n(t)}))}))]).then((([t])=>function(t){return Promise.all([l(t.corporation_id),d(t.alliance_id)])}(t)))},fetchCombatStats:i.combatStats.fetchCombatStats,fetchShipStats:i.shipStats.fetchShipStats,getId:c};function c(){return s}function l(e){return new Promise(((s,r)=>{if(!e)return u(void 0),s(void 0);t.libNet.load(`${t.ENDPOINT_ESI}/corporations/${e}`).then((function(t){return u(t),function(t){a.militia.textContent=function(t){switch(t){case n.CALDARI:return"Caldari militia";case n.MINMATAR:return"Minmatar militia";case n.AMARR:return"Amarr militia";case n.GALLENTE:return"Gallente militia";default:return"Neutral"}}(t),a.militia.classList.toggle("busy",!1),a.militia.classList.toggle("hidden",!t),a.affiliation.dataset.militia=o[t]||"neutral",a.affiliation.classList.toggle("busy",!1)}(t.faction_id),s(t)})).catch(r)}))}function u(t){a.corp.textContent=t?.ticker||"N/A",a.corp.title=t?.name||"N/A",a.corp.classList.toggle("busy",!1),a.corp.classList.toggle("hidden",!t),a.affiliation.classList.toggle("busy",!1)}function d(e){return new Promise(((n,o)=>{if(!e)return h(void 0),n(void 0);t.libNet.load(`${t.ENDPOINT_ESI}/alliances/${e}`).then((function(t){return h(t),n(t)})).catch(o)}))}function h(t){a.alliance.textContent=t?.ticker||"N/A",a.alliance.title=t?.name||"N/A",a.alliance.classList.toggle("busy",!1),a.alliance.classList.toggle("hidden",!t),a.affiliation.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateShipStatsTile");t.ShipStatsTile=(n={})=>{const o=document.importNode(e.content,!0).firstChild,s={name:o.querySelector(".ShipStatsTile-name"),stats:o.querySelector(".ShipStatsTile-stats"),losses:o.querySelector(".ShipStatsTile-losses"),kills:o.querySelector(".ShipStatsTile-kills")};return r(n),{render:function(){return o},setShipStats:r};function r(e={}){s.name.textContent=e?.info?.name||"???",o.href=`https://zkillboard.com/ship/${e.id}`,o.style.opacity=e.ratio||1,o.title=[t.humanisePlural(e.kills||0,"recent kill","recent kills"),t.humanisePlural(e.losses||0,"recent loss","recent losses"),`Last fight: ${t.humaniseDate(e.dateLastSeen)}`].join("\n");const n=e.kills+e.losses,r=e.kills/(n||1),a=e.losses/(n||1);o.style.backgroundColor=function(t){const e=120;return`hsla(${Math.round(t*e)}, 100%, 50%, 0.1)`}(a),s.losses.style.width=100*a+"%",s.kills.style.width=100*r+"%"}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateCombatStats");t.CombatStats=n=>{const o=document.importNode(e.content,!0).firstChild,s={doFetch:o.querySelector(".CombatStats-fetch-stats"),solo:o.querySelector(".CombatStats-solo"),gangs:o.querySelector(".CombatStats-gangs"),losses:o.querySelector(".CombatStats-losses")};return s.doFetch.addEventListener("click",(()=>i(!1)),{passive:!0}),a(),{render:function(){return o},fetchCombatStats:i};function r(){return n}function a(){s.doFetch.textContent="Get combat stats",s.doFetch.classList.toggle("busy",!1)}function i(e=!0){return new Promise(((n,i)=>{if(!r())return n(void 0);s.doFetch.textContent="Getting combat stats",s.doFetch.classList.toggle("busy",!0),t.libNet.load(`${t.ENDPOINT_ZKB}/stats/characterID/${r()}/`,!!e).then((function(e){return function(e={}){const n=e?.shipsLost||0,i=e?.shipsDestroyed||0,c=e?.soloKills||0,l=i-c,u=n/(i+n||1),d=l/(i||1),h=c/(i||1);s.solo.textContent=t.humaniseCount(c),s.gangs.textContent=t.humaniseCount(l),s.losses.textContent=t.humaniseCount(n),s.solo.href=`https://zkillboard.com/character/${r()}/solo`,s.gangs.href=`https://zkillboard.com/character/${r()}/kills`,s.losses.href=`https://zkillboard.com/character/${r()}/losses`,s.solo.style.opacity=h,s.gangs.style.opacity=d,s.losses.style.opacity=u,o.classList.toggle("ready",!0),a()}(e),n(e)})).catch((function(t){return s.doFetch.textContent="Could not",setTimeout((()=>{o.classList.toggle("ready",!1),a()}),1e3),i(t)}))}))}}})(window.A);
