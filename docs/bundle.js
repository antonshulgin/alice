(t=>{"use strict";function e(t=0){return t>1e3?`${(t/1e3).toFixed(1)}k`:t}window.addEventListener("DOMContentLoaded",(function(){const e={controls:document.getElementById("Controls"),overview:document.getElementById("Overview")},n={lookup:t.Lookup({onResolved:function(n=[]){i(),Promise.any(n.map((n=>function(n){const s=t.Pilot(n);function i(){setTimeout(s.fetchDetails,o()),setTimeout(s.fetchCombatStats,o()),setTimeout(s.fetchShipStats,o())}e.overview.appendChild(s.render()),t.libCache.getItem(`pilotIds/${n}`).then((()=>{i()})).catch((()=>{t.libCache.saveItem(`pilotIds/${n}`,n),i()}))}(n)))).then(s).catch(console.error)}})};function o(){return Math.round(7*Math.random())}function s(n){e.overview.classList.toggle("hidden",n?.length<=0),t.libCache.clearExpired()}function i(){t.libNet.resetTimedQueryCount(),e.overview.classList.toggle("hidden",!0),e.overview.replaceChildren()}i(),e.controls.appendChild(n.lookup.render()),n.lookup.setFocus()}),{once:!0,passive:!0}),t.ENDPOINT_ESI="https://esi.evetech.net/dev",t.ENDPOINT_ZKB="https://zkillboard.com/api",t.TYPE_IDS_IGNORED=[33328,33474,33475,57319,670,NaN,null,void 0],t.humanisePlural=function(t,n,o){return 1===t?`${e(t)} ${n}`:`${e(t)} ${o||n}`},t.humaniseCount=e,t.humaniseDate=function(t=new Date){return t?.toLocaleDateString()||"???"}})(window.A={}),(t=>{"use strict";function e(t={}){if(!t?.lastCached)return!0;return Math.abs(Date.now()-t.lastCached)>=18e5}function n(t=""){return new Promise(((e,n)=>{let o;try{o=JSON.parse(t)}catch(e){return console.warn("Failed to decode JSON",{jsonString:t}),n(t)}return e(o)}))}t.libCache={clearExpired:function(){return new Promise(((t,o)=>(Object.values(localStorage).forEach((t=>{n(t).then((t=>{var n;e(t)&&(n=t.key,new Promise((t=>(localStorage.removeItem(n),t()))))})).catch(o)})),t())))},getItem:function(t){return new Promise(((o,s)=>{n(localStorage.getItem(t)).then((function(t={}){return e(t)?s():o(t.value)})).catch(s)}))},saveItem:function(t,e={}){return new Promise(((n,o)=>{const s={key:t,value:e,lastCached:Date.now()};(function(t={}){return new Promise(((e,n)=>{let o;try{o=JSON.stringify(t)}catch(e){return console.warn("Failed to encode JSON",{json:t}),n(t)}return e(o)}))})(s).then((function(e){return localStorage.setItem(t,e),n(s.value)})).catch(o)}))}}})(window.A),(t=>{"use strict";const e={timedQueryCount:0};t.libNet={resetTimedQueryCount:function(){e.timedQueryCount=0},load:function(n="",o=!1){return new Promise(((s,i)=>{if(!n)return console.error("No URL given"),i();function r(){fetch(n).then((t=>t.json())).then((e=>t.libCache.saveItem(n,e))).then((t=>s(t))).catch(i)}t.libCache.getItem(n).then((t=>s(t))).catch((()=>setTimeout(r,o?1e3*(e.timedQueryCount+=1,e.timedQueryCount||0):0)))}))}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateLookup");t.Lookup=(n={})=>{const o=document.importNode(e.content,!0).firstChild;return o.addEventListener("submit",(function(t){t.preventDefault(),o.doLookup.textContent="Working",o.doLookup.classList.toggle("busy",!0),Promise.resolve(o.names.value).then((t=>i(t))).then((t=>function(t=[]){return new Promise(((e,n)=>{Promise.all(t.map(r)).then((t=>e(t.flat(1)))).catch(n)}))}(t))).then((t=>function(t){return function(){o.doLookup.textContent="Ready",o.doLookup.classList.toggle("busy",!0),setTimeout(c,1e3)}(),n?.onResolved(t)}(t))).catch(a)})),o.names.addEventListener("focus",s),{setFocus:s,render:function(){return o},parseNames:i};function s(){o.names.select()}function i(t=""){return new Promise((e=>e([...new Set(t.split(/\n+/).map((t=>t.trim().toLowerCase())).filter((t=>t.length>0)))])))}function r(e=""){return new Promise(((n,o)=>{t.libNet.load(`${t.ENDPOINT_ESI}/search/?search=${encodeURIComponent(e)}&categories=character&strict=true`).then((function(t){return n(t?.character||[])})).catch(o)}))}function a(t){console.error(t),o.doLookup.textContent="Could not",o.doLookup.classList.toggle("busy",!0),setTimeout(c,1e3)}function c(){o.doLookup.textContent="Look up",o.doLookup.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateShipStats");t.ShipStats=n=>{const o=document.importNode(e.content,!0).firstChild,s={doFetch:o.querySelector(".ShipStats-fetch-stats"),ships:o.querySelector(".ShipStats-ships")};return s.doFetch.addEventListener("click",(()=>i(!1)),{passive:!0}),{render:function(){return o},fetchShipStats:i};function i(e=!0){return new Promise(((n,i)=>{if(!a())return n(void 0);s.doFetch.textContent="Getting ship stats",s.doFetch.classList.toggle("busy",!0),Promise.resolve().then((()=>function(e=!0){return t.libNet.load(`${t.ENDPOINT_ZKB}/characterID/${a()}/`,!!e)}(e))).then((t=>function(t=[]){return Promise.all(t.slice(0,7).map(c))}(t))).then((e=>function(e=[]){return new Promise((n=>{const o=e.reduce(((e,n)=>e.concat(function(e,n){return[].concat(function(e,n){const o=parseInt(e.victim.character_id),s=parseInt(e.victim.ship_type_id);if(isNaN(o)||isNaN(s))return;if(t.TYPE_IDS_IGNORED.includes(s))return;if(o!==n)return;return{characterId:o,date:new Date(e.killmail_time),id:s,info:{},isKill:!1}}(e,n),function(e,n){const o=e.attackers.reduce(((o,s)=>{const i=parseInt(s.character_id),r=parseInt(s.ship_type_id);return isNaN(i)||isNaN(r)||t.TYPE_IDS_IGNORED.includes(r)||i!==n?o:o.concat({characterId:i,date:new Date(e.killmail_time),id:r,info:{},isKill:!0})}),[]);return o}(e,n)).flat(1).filter((t=>!!t))}(n,a()))),[]).sort(((t,e)=>e.date-t.date));return n(function(t=[]){const e=t.reduce(((t,e)=>{var n,o;return t[e.id]||(t[e.id]={id:e.id,fights:[],losses:0,kills:0,total:0,dates:[]}),t[e.id]=(n=e,(o=t[e.id]).total+=1,o.losses+=n.isKill?0:1,o.kills+=n.isKill?1:0,o.fights.push(n),o.dates.push(n.date),o.dates.sort(((t,e)=>e-t)),o),t}),{});Object.values(e).forEach((t=>{t.dateLastSeen=t.dates.sort(((t,e)=>e-t))[0]}));return Object.values(e).sort(((t,e)=>e.dateLastSeen-t.dateLastSeen)).slice(0,3)}(o))}))}(e))).then((t=>function(t=[]){return new Promise(((e,n)=>{function o(t){return e(t)}Promise.all(t.map(r)).then(o).catch(n)}))}(t))).then((t=>function(t=[]){return new Promise((e=>{const n=t.reduce(((t,e)=>e.total>t?e.total:t),0);return t.forEach((t=>{t.ratio=t.total/(n||1)})),e(t)}))}(t))).then((e=>function(e){return function(e=[]){const n=e.map(t.ShipStatsTile);s.ships.replaceChildren(...n.map((t=>t.render()))),o.classList.toggle("ready",!0),l()}(e),n(e)}(e))).catch((function(t){return s.doFetch.textContent="Could not",setTimeout(l,1e3),i(t)}))}))}function r(e={}){return new Promise(((n,o)=>{t.libNet.load(`${t.ENDPOINT_ESI}/universe/types/${e.id}`).then((function(t){return e.info=t,n(e)})).catch(o)}))}function a(){return n}function c(e={}){return t.libNet.load(`${t.ENDPOINT_ESI}/killmails/${e.killmail_id}/${e.zkb.hash}`)}function l(){s.doFetch.textContent="Get ship stats",s.doFetch.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templatePilot"),n={CALDARI:500001,MINMATAR:500002,AMARR:500003,GALLENTE:500004},o={[n.CALDARI]:"caldari",[n.MINMATAR]:"minmatar",[n.AMARR]:"amarr",[n.GALLENTE]:"gallente"};t.Pilot=s=>{const i=document.importNode(e.content,!0).firstChild,r={portrait:i.querySelector(".Pilot-portrait"),summary:i.querySelector(".Pilot-summary"),status:i.querySelector(".Pilot-status"),name:i.querySelector(".Pilot-name"),affiliation:i.querySelector(".Pilot-affiliation"),alliance:i.querySelector(".Pilot-alliance"),corp:i.querySelector(".Pilot-corp"),militia:i.querySelector(".Pilot-militia"),combatStats:i.querySelector(".Pilot-combat-stats"),shipStats:i.querySelector(".Pilot-ship-stats")},a={combatStats:t.CombatStats(c()),shipStats:t.ShipStats(c())};return r.combatStats.replaceChildren(a.combatStats.render()),r.shipStats.replaceChildren(a.shipStats.render()),{MILITIA_ID:n,MILITIA_LABEL:o,render:function(){return i},fetchDetails:function(){Promise.all([new Promise(((e,n)=>{[r.portrait,r.status,r.name,r.alliance,r.corp,r.militia].forEach((t=>t.classList.toggle("busy",!0))),t.libNet.load(`${t.ENDPOINT_ESI}/characters/${c()}`).then((function(t){return function(t){r.summary.href=`https://zkillboard.com/character/${c()}`,r.name.textContent=t,r.name.classList.toggle("busy",!1)}(t.name),function(t=0){r.status.dataset.status=Math.round(t)||0,r.status.classList.toggle("busy",!1)}(t.security_status),e(t)})).catch((function(t){return r.portrait.classList.toggle("busy",!1),n(t)}))})),new Promise(((e,n)=>{r.portrait.classList.toggle("busy",!0),t.libNet.load(`${t.ENDPOINT_ESI}/characters/${c()}/portrait`).then((function(t){return function(t={}){r.portrait.src=t.px64x64||"",r.portrait.classList.toggle("busy",!1)}(t),e(t)})).catch((function(t){return r.portrait.classList.toggle("busy",!1),n(t)}))}))]).then((([t])=>function(t){return Promise.all([l(t.corporation_id),d(t.alliance_id)])}(t)))},fetchCombatStats:a.combatStats.fetchCombatStats,fetchShipStats:a.shipStats.fetchShipStats,getId:c};function c(){return s}function l(e){return new Promise(((s,i)=>{if(!e)return u(void 0),s(void 0);t.libNet.load(`${t.ENDPOINT_ESI}/corporations/${e}`).then((function(t){return u(t),function(t){r.militia.textContent=function(t){switch(t){case n.CALDARI:return"Caldari militia";case n.MINMATAR:return"Minmatar militia";case n.AMARR:return"Amarr militia";case n.GALLENTE:return"Gallente militia";default:return"Neutral"}}(t),r.militia.classList.toggle("busy",!1),r.militia.classList.toggle("hidden",!t),r.affiliation.dataset.militia=o[t]||"neutral",r.affiliation.classList.toggle("busy",!1)}(t.faction_id),s(t)})).catch(i)}))}function u(t){r.corp.textContent=t?.ticker||"N/A",r.corp.title=t?.name||"N/A",r.corp.classList.toggle("busy",!1),r.corp.classList.toggle("hidden",!t),r.affiliation.classList.toggle("busy",!1)}function d(e){return new Promise(((n,o)=>{if(!e)return h(void 0),n(void 0);t.libNet.load(`${t.ENDPOINT_ESI}/alliances/${e}`).then((function(t){return h(t),n(t)})).catch(o)}))}function h(t){r.alliance.textContent=t?.ticker||"N/A",r.alliance.title=t?.name||"N/A",r.alliance.classList.toggle("busy",!1),r.alliance.classList.toggle("hidden",!t),r.affiliation.classList.toggle("busy",!1)}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateShipStatsTile");t.ShipStatsTile=(n={})=>{const o=document.importNode(e.content,!0).firstChild,s={name:o.querySelector(".ShipStatsTile-name"),stats:o.querySelector(".ShipStatsTile-stats"),losses:o.querySelector(".ShipStatsTile-losses"),kills:o.querySelector(".ShipStatsTile-kills")};return i(n),{render:function(){return o},setShipStats:i};function i(e={}){s.name.textContent=e?.info?.name||"???",o.href=`https://zkillboard.com/ship/${e.id}`,o.style.opacity=e.ratio||1,o.title=[t.humanisePlural(e.kills||0,"recent kill","recent kills"),t.humanisePlural(e.losses||0,"recent loss","recent losses"),`Last fight: ${t.humaniseDate(e.dateLastSeen)}`].join("\n");const n=e.kills+e.losses,i=e.kills/(n||1),r=e.losses/(n||1);o.style.backgroundColor=function(t){const e=120;return`hsla(${Math.round(t*e)}, 100%, 50%, 0.1)`}(r),s.losses.style.width=100*r+"%",s.kills.style.width=100*i+"%"}}})(window.A),(t=>{"use strict";const e=document.getElementById("templateCombatStats");t.CombatStats=n=>{const o=document.importNode(e.content,!0).firstChild,s={doFetch:o.querySelector(".CombatStats-fetch-stats"),solo:o.querySelector(".CombatStats-solo"),gangs:o.querySelector(".CombatStats-gangs"),losses:o.querySelector(".CombatStats-losses")};return s.doFetch.addEventListener("click",(()=>a(!1)),{passive:!0}),r(),{render:function(){return o},fetchCombatStats:a};function i(){return n}function r(){s.doFetch.textContent="Get combat stats",s.doFetch.classList.toggle("busy",!1)}function a(e=!0){return new Promise(((n,a)=>{if(!i())return n(void 0);s.doFetch.textContent="Getting combat stats",s.doFetch.classList.toggle("busy",!0),t.libNet.load(`${t.ENDPOINT_ZKB}/stats/characterID/${i()}/`,!!e).then((function(e){return function(e={}){const n=e?.shipsLost||0,a=e?.shipsDestroyed||0,c=e?.soloKills||0,l=a-c,u=n/(a+n||1),d=l/(a||1),h=c/(a||1);s.solo.textContent=t.humaniseCount(c),s.gangs.textContent=t.humaniseCount(l),s.losses.textContent=t.humaniseCount(n),s.solo.href=`https://zkillboard.com/character/${i()}/solo`,s.gangs.href=`https://zkillboard.com/character/${i()}/kills`,s.losses.href=`https://zkillboard.com/character/${i()}/losses`,s.solo.style.opacity=h,s.gangs.style.opacity=d,s.losses.style.opacity=u,o.classList.toggle("ready",!0),r()}(e),n(e)})).catch((function(t){return s.doFetch.textContent="Could not",setTimeout((()=>{o.classList.toggle("ready",!1),r()}),1e3),a(t)}))}))}}})(window.A);
